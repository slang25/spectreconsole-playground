@using Spectre.Docs.Playground.Services
@inject CompilationService CompilationService
@inject ExecutionService ExecutionService
@inject UrlStateService UrlStateService

<div class="playground-container">
    <div class="editor-panel">
        <div class="panel-header">
            <div class="editor-header-left">
                <span>Code Editor</span>
                <select class="examples-select" @onchange="OnExampleSelected">
                    <option value="">Examples...</option>
                    @foreach (var example in Examples)
                    {
                        <option value="@example.Key">@example.Key</option>
                    }
                </select>
            </div>
            <button class="run-button" @onclick="RunCode" disabled="@_isRunning">
                @if (_isRunning)
                {
                    <span>Running...</span>
                }
                else
                {
                    <span>Run</span>
                }
            </button>
        </div>
        <div class="panel-content">
            @if (_initialCodeLoaded)
            {
                <PlaygroundEditor @ref="_codeEditor" InitialCode="@_initialCode" />
            }
        </div>
        @if (_compilationErrors.Count > 0)
        {
            <div class="error-panel">
                @foreach (var error in _compilationErrors)
                {
                    <div>@error</div>
                }
            </div>
        }
    </div>
    <div class="resizer" id="panel-resizer"></div>
    <div class="terminal-panel">
        <div class="panel-header">
            <span>Terminal Output</span>
            <div class="terminal-header-buttons">
@if (_isRunning)
                {
                    <button class="stop-button" @onclick="StopCode">Stop</button>
                }
                <button class="clear-button" @onclick="ClearTerminal">Clear</button>
            </div>
        </div>
        <div class="panel-content">
            <div class="terminal-frame">
                <div class="terminal-dots">
                    <div class="terminal-dot terminal-dot-1"></div>
                    <div class="terminal-dot terminal-dot-2"></div>
                    <div class="terminal-dot terminal-dot-3"></div>
                </div>
                <div class="terminal-inner">
                    <SharedTerminal @ref="_terminal" OnCtrlCPressed="StopCode" />
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private PlaygroundEditor? _codeEditor;
    private SharedTerminal? _terminal;
    private SharedTerminalIO? _terminalIO;
    private bool _isRunning;
    private List<string> _compilationErrors = [];
    private bool _hasPlayedWelcome;
    private string? _initialCode;
    private bool _initialCodeLoaded;
    private bool _runImmediately;

    private static readonly Dictionary<string, string> Examples = new()
    {
        ["Tables"] = """
            // Create a simple table
            var table = new Table();
            table.Border(TableBorder.Rounded);

            // Add columns
            table.AddColumn("[cyan]Name[/]");
            table.AddColumn("[cyan]Age[/]");
            table.AddColumn("[cyan]City[/]");

            // Add rows
            table.AddRow("Alice", "30", "New York");
            table.AddRow("Bob", "25", "Los Angeles");
            table.AddRow("Charlie", "35", "Chicago");

            AnsiConsole.Write(table);
            """,

        ["Progress Bar"] = """
            // Simulate a download with progress
            AnsiConsole.Progress()
                .Start(ctx =>
                {
                    var task = ctx.AddTask("[green]Downloading files[/]");

                    while (!ctx.IsFinished)
                    {
                        task.Increment(3.5);
                        Thread.Sleep(50);
                    }
                });

            AnsiConsole.MarkupLine("[green]Download complete![/]");
            """,

        ["Tree View"] = """
            // Create a tree structure
            var root = new Tree("[yellow]Solution[/]");

            var src = root.AddNode("[blue]src[/]");
            var project = src.AddNode("[green]MyProject[/]");
            project.AddNode("Program.cs");
            project.AddNode("Startup.cs");
            project.AddNode("appsettings.json");

            var tests = root.AddNode("[blue]tests[/]");
            var testProject = tests.AddNode("[green]MyProject.Tests[/]");
            testProject.AddNode("UnitTests.cs");
            testProject.AddNode("IntegrationTests.cs");

            root.AddNode("README.md");
            root.AddNode(".gitignore");

            AnsiConsole.Write(root);
            """,

        ["Bar Chart"] = """
            // Create a bar chart
            AnsiConsole.Write(new BarChart()
                .Width(60)
                .Label("[green bold underline]Programming Languages[/]")
                .CenterLabel()
                .AddItem("C#", 85, Color.Green)
                .AddItem("Python", 78, Color.Blue)
                .AddItem("JavaScript", 72, Color.Yellow)
                .AddItem("Rust", 45, Color.Red)
                .AddItem("Go", 52, Color.Cyan1));
            """,

        ["Panels"] = """
            // Create styled panels
            var panel = new Panel(
                Align.Center(
                    new Markup("[blue]Hello[/] from [red]Spectre.Console[/]!"),
                    VerticalAlignment.Middle))
                .Header("[yellow]Welcome[/]")
                .Border(BoxBorder.Rounded)
                .BorderStyle(Style.Parse("cyan"))
                .Padding(2, 1);

            AnsiConsole.Write(panel);

            AnsiConsole.WriteLine();

            // Nested panels
            var inner = new Panel("This is the [green]inner[/] panel")
                .Header("Inner")
                .Border(BoxBorder.Double);

            var outer = new Panel(inner)
                .Header("Outer")
                .Border(BoxBorder.Rounded)
                .Padding(1, 1);

            AnsiConsole.Write(outer);
            """,

        ["Prompt Selection"] = """
            // Single selection
            var fruit = AnsiConsole.Prompt(
                new SelectionPrompt<string>()
                    .Title("What's your [green]favorite fruit[/]?")
                    .PageSize(5)
                    .AddChoices(new[] {
                        "Apple", "Banana", "Orange",
                        "Mango", "Strawberry", "Grape"
                    }));

            AnsiConsole.MarkupLine($"You selected: [yellow]{fruit}[/]");

            AnsiConsole.WriteLine();

            // Multi selection
            var toppings = AnsiConsole.Prompt(
                new MultiSelectionPrompt<string>()
                    .Title("Select your [green]pizza toppings[/]:")
                    .NotRequired()
                    .PageSize(5)
                    .InstructionsText("[grey](Press [blue]<space>[/] to toggle, [green]<enter>[/] to accept)[/]")
                    .AddChoices(new[] {
                        "Pepperoni", "Mushrooms", "Olives",
                        "Onions", "Bacon", "Extra Cheese"
                    }));

            AnsiConsole.MarkupLine($"Toppings: [cyan]{string.Join(", ", toppings)}[/]");
            """,

        ["Calendar"] = """
            // Display a calendar
            var calendar = new Calendar(2025, 1)
                .AddCalendarEvent(2025, 1, 1)   // New Year's Day
                .AddCalendarEvent(2025, 1, 20)  // MLK Day
                .HighlightStyle(Style.Parse("yellow bold"))
                .HeaderStyle(Style.Parse("blue"));

            AnsiConsole.Write(calendar);

            AnsiConsole.WriteLine();

            // Show current date info
            var today = DateTime.Now;
            AnsiConsole.MarkupLine($"[grey]Today is[/] [green]{today:dddd, MMMM d, yyyy}[/]");
            """,

        ["Exceptions"] = """
            // Pretty print exceptions
            try
            {
                DoSomething();
            }
            catch (Exception ex)
            {
                AnsiConsole.WriteException(ex,
                    ExceptionFormats.ShortenPaths |
                    ExceptionFormats.ShortenTypes |
                    ExceptionFormats.ShortenMethods);
            }

            void DoSomething()
            {
                DoSomethingElse();
            }

            void DoSomethingElse()
            {
                throw new InvalidOperationException("Something went wrong!");
            }
            """,

        ["Canvas"] = """
            // Draw on a canvas
            var canvas = new Canvas(16, 16);

            // Draw a simple pattern
            for (int i = 0; i < 16; i++)
            {
                canvas.SetPixel(i, 0, Color.Red);
                canvas.SetPixel(i, 15, Color.Red);
                canvas.SetPixel(0, i, Color.Blue);
                canvas.SetPixel(15, i, Color.Blue);
            }

            // Draw diagonals
            for (int i = 0; i < 16; i++)
            {
                canvas.SetPixel(i, i, Color.Green);
                canvas.SetPixel(15 - i, i, Color.Yellow);
            }

            AnsiConsole.Write(canvas);
            """,

        ["Live Display"] = """
            // Live updating display
            var table = new Table().Border(TableBorder.Rounded);
            table.AddColumn("Time");
            table.AddColumn("Status");

            AnsiConsole.Live(table)
                .Start(ctx =>
                {
                    for (int i = 1; i <= 5; i++)
                    {
                        table.AddRow(
                            DateTime.Now.ToString("HH:mm:ss"),
                            $"[green]Step {i} complete[/]");
                        ctx.Refresh();
                        Thread.Sleep(500);
                    }
                });

            AnsiConsole.MarkupLine("[yellow]All steps completed![/]");
            """
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Try to load payload from URL hash before rendering editor
            try
            {
                var payload = await UrlStateService.GetPayloadFromUrlAsync();
                if (payload != null && !string.IsNullOrEmpty(payload.Code))
                {
                    _initialCode = payload.Code;
                    _runImmediately = payload.RunImmediately;
                    // Skip welcome animation when loading shared code
                    _hasPlayedWelcome = true;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to load code from URL: {ex.Message}");
                // Continue without URL code - will use default
            }

            // Now we can render the editor with the correct initial code
            _initialCodeLoaded = true;
            StateHasChanged();

            if (_runImmediately)
            {
                // Run immediately after a brief delay to allow editor to initialize
                _runImmediately = false;
                await Task.Delay(100);
                await RunCode();
            }
            else if (!_hasPlayedWelcome && _terminal != null)
            {
                _hasPlayedWelcome = true;
                await Task.Delay(300);

                try
                {
                    // Initialize terminal for the welcome animation
                    _terminalIO = await _terminal.InitializeAsync();
                    await PlayWelcomeAnimation();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Failed to initialize terminal: {ex.Message}");
                    // Terminal initialization failed - the app can still function,
                    // user can try running code which will attempt to reinitialize
                }
            }
        }
    }

    private async Task PlayWelcomeAnimation()
    {
        if (_terminal == null) return;

        var (cols, rows) = await _terminal.GetSize();
        var width = cols - 1;
        var height = rows - 1;

        await _terminal.Write("\x1b[?25l\x1b[H");

        // Calculate center for "Welcome"
        var welcomeText = "Welcome";
        var centerRow = height / 2 + 1;
        var centerCol = (width - welcomeText.Length) / 2 + 1;
        var welcomeIndex = 0;

        // Total perimeter steps for even distribution of welcome letters
        var perimeterLength = (width * 2) + (height * 2);
        var welcomeInterval = perimeterLength / (welcomeText.Length + 1);
        var stepCount = 0;

        // Top border
        await _terminal.Write($"\x1b[38;5;244m╭");
        for (int i = 0; i < width - 1; i++)
        {
            await _terminal.Write("─");
            stepCount++;
            if (welcomeIndex < welcomeText.Length && stepCount % welcomeInterval == 0)
            {
                await _terminal.Write($"\x1b[{centerRow};{centerCol + welcomeIndex}H\x1b[33;1m{welcomeText[welcomeIndex]}\x1b[0m");
                await _terminal.Write($"\x1b[1;{i + 3}H");
                welcomeIndex++;
            }
            if (i % 6 == 0) await Task.Delay(8);
        }
        await _terminal.Write("╮\x1b[0m");

        // Right side
        for (int i = 2; i <= height; i++)
        {
            await _terminal.Write($"\x1b[{i};{width + 1}H\x1b[38;5;244m│\x1b[0m");
            stepCount++;
            if (welcomeIndex < welcomeText.Length && stepCount % welcomeInterval == 0)
            {
                await _terminal.Write($"\x1b[{centerRow};{centerCol + welcomeIndex}H\x1b[33;1m{welcomeText[welcomeIndex]}\x1b[0m");
                welcomeIndex++;
            }
            if (i % 2 == 0) await Task.Delay(12);
        }

        // Bottom border
        await _terminal.Write($"\x1b[{height + 1};{width + 1}H\x1b[38;5;244m╯");
        for (int i = width - 1; i >= 1; i--)
        {
            await _terminal.Write($"\x1b[{height + 1};{i + 1}H─");
            stepCount++;
            if (welcomeIndex < welcomeText.Length && stepCount % welcomeInterval == 0)
            {
                await _terminal.Write($"\x1b[{centerRow};{centerCol + welcomeIndex}H\x1b[33;1m{welcomeText[welcomeIndex]}\x1b[0m");
                await _terminal.Write($"\x1b[{height + 1};{i}H");
                welcomeIndex++;
            }
            if (i % 6 == 0) await Task.Delay(8);
        }
        await _terminal.Write($"\x1b[{height + 1};1H╰\x1b[0m");

        // Left side
        for (int i = height; i >= 2; i--)
        {
            await _terminal.Write($"\x1b[{i};1H\x1b[38;5;244m│\x1b[0m");
            stepCount++;
            if (welcomeIndex < welcomeText.Length && stepCount % welcomeInterval == 0)
            {
                await _terminal.Write($"\x1b[{centerRow};{centerCol + welcomeIndex}H\x1b[33;1m{welcomeText[welcomeIndex]}\x1b[0m");
                welcomeIndex++;
            }
            if (i % 2 == 0) await Task.Delay(12);
        }

        // Show any remaining letters
        while (welcomeIndex < welcomeText.Length)
        {
            await _terminal.Write($"\x1b[{centerRow};{centerCol + welcomeIndex}H\x1b[33;1m{welcomeText[welcomeIndex]}\x1b[0m");
            welcomeIndex++;
            await Task.Delay(40);
        }

        await Task.Delay(500);

        // Clear and show cursor
        await _terminal.Write("\x1b[2J\x1b[H\x1b[?25h");
    }

    private async Task OnExampleSelected(ChangeEventArgs e)
    {
        var selectedKey = e.Value?.ToString();
        if (!string.IsNullOrEmpty(selectedKey) && Examples.TryGetValue(selectedKey, out var code))
        {
            if (_codeEditor != null)
            {
                await _codeEditor.SetCode(code);
            }
        }
    }

    private async Task RunCode()
    {
        if (_isRunning || _codeEditor == null || _terminal == null)
            return;

        _isRunning = true;
        _compilationErrors.Clear();
        Services.SharedTerminalIO.SetExecutionRunning(true);
        StateHasChanged();

        try
        {
            // Initialize SharedTerminalIO if needed (this starts the terminal)
            _terminalIO ??= await _terminal.InitializeAsync();

            // Reset the terminal IO for a fresh execution (creates new CancellationTokenSource)
            _terminalIO.Reset();

            await _terminal.Clear();
            await _terminal.Focus();

            var code = await _codeEditor.GetCode();

            // Update URL with compressed code for sharing
            await UrlStateService.UpdateUrlAsync(code);

            // Compile the code
            var compilationResult = await CompilationService.CompileAsync(code);

            if (!compilationResult.Success)
            {
                _compilationErrors = compilationResult.Diagnostics
                    .Where(d => d.Severity == Microsoft.CodeAnalysis.DiagnosticSeverity.Error)
                    .Select(d => $"({d.Location.GetLineSpan().StartLinePosition.Line + 1},{d.Location.GetLineSpan().StartLinePosition.Character + 1}): {d.GetMessage()}")
                    .ToList();
                return;
            }

            // Get terminal size
            var (cols, rows) = await _terminal.GetSize();

            // Execute the compiled assembly using SharedTerminalIO
            // Cancellation is handled by SharedTerminalIO (Stop button or Ctrl+C)
            await ExecutionService.ExecuteAsync(
                compilationResult.Assembly!,
                _terminalIO,
                cols,
                rows);
        }
        catch (Exception ex)
        {
            await _terminal.WriteLine($"\e[31mError: {ex.Message}\e[0m");
        }
        finally
        {
            _isRunning = false;
            Services.SharedTerminalIO.SetExecutionRunning(false);
            StateHasChanged();
        }
    }

    private async Task ClearTerminal()
    {
        if (_terminal != null)
        {
            await _terminal.Clear();
        }
    }

    private Task StopCode()
    {
        _terminalIO?.Cancel();
        return Task.CompletedTask;
    }

    public ValueTask DisposeAsync()
    {
        _terminalIO?.Cancel();
        return ValueTask.CompletedTask;
    }
}
